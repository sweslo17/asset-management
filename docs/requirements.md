# 投資組合管理系統 — 需求書

## 產品定位

個人投資組合追蹤工具，追蹤台股與美股持倉的即時價值與歷史損益，並依資金來源做公平的獲利分配。以 PWA 網頁形式提供，僅限本人使用。

## 資料模型

### 投入 (Batch)

一次投入行為，包含：
- 日期、說明
- 一至多筆**資金來源**（來源名稱 + 金額 TWD）
- 一至多筆**投資標的**

### 投資標的 (Investment)

- 屬於某個 Batch
- 必填欄位：Yahoo Finance 代碼、顯示名稱、市場（台股/美股）、買入日期、數量、每股買入價、匯率（台股固定為 1）、手續費
- 可設定多個標籤（逗號分隔）

### 成本計算

- 台股：張數 x 1000 x 每股價格 + 手續費（TWD）
- 美股：股數 x 每股價格 x 匯率 + 手續費（TWD）

### 股價與匯率

由排程任務每日自動更新，從 Yahoo Finance 取得：
- 各持有標的的收盤價
- USD/TWD 匯率
- 首次執行時回填歷史資料

## 頁面與功能

### 1. 投資總覽 (Dashboard)

顯示截至最新價格日的快照：
- 總市值、總成本、總損益（金額 + 百分比）
- 持倉明細表：每檔標的的持有量、市值、損益、報酬率

### 2. 損益分析 (Profit/Loss)

- 可選擇起始與結束日期
- 顯示每檔標的在該區間的期初市值、期末市值、損益、報酬率
- 合計列

### 3. 分類分析 (Category)

- 依標籤分組，顯示每個分類的市值、成本、損益
- 顯示各分類佔總市值的比例
- 可展開查看分類內的個別標的

### 4. 資金來源 (Funding)

依 NAV 單位制計算各來源的投資價值：
- 顯示目前 NAV、總發行單位數
- 每個來源的持有單位、投入金額、目前價值、損益、報酬率

### 5. 投入紀錄 (Batch)

依 NAV 單位制計算每次投入的損益：
- 每筆 Batch 的投入金額、目前價值、損益、報酬率

### 6. 管理

- **新增投入**：4 步驟表單（基本資訊 → 資金來源 → 投資標的 → 確認）
  - 資金來源可動態增減
  - 投資標的可動態增減，即時顯示成本小計與剩餘未投入金額
  - 台股選擇時匯率自動設為 1，美股自動設為 30
- **瀏覽現有 Batch**：依日期倒序顯示，展示資金來源與投資明細
- **編輯投資記錄**：點擊投資項目開啟編輯對話框
- **刪除投資記錄**：編輯對話框中的刪除按鈕，需確認
- **刪除整筆 Batch**：連同相關資金來源與投資記錄一併刪除，需確認

## NAV 單位制

解決多個資金來源的公平獲利分配問題。

**規則：**
1. 整個投資組合視為一個基金池（投資市值 + 現金）
2. 每次投入資金，依當時 NAV 購買單位（首次 NAV = 1.0）
3. 各來源持有各自的單位數
4. 來源價值 = 持有單位 x 當前 NAV
5. 較早投入的資金，因持有較多時間自然累積更多價值

## 存取控制

- API 金鑰保護：所有 API 請求必須帶 `X-API-Key` header
- 前端密碼閘門：未持有金鑰時顯示登入畫面，輸入後存於 localStorage
- 金鑰錯誤或被撤銷時自動清除並回到登入畫面

## 版面

- 桌面：左側固定側邊欄導航 + 右側內容區
- 手機：底部導航列，內容區全寬
- PWA 支援，可安裝到手機桌面
